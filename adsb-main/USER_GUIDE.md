# ADS-B 数据回放功能 - 用户指南

## 📘 功能概述

ADS-B 数据回放功能允许您录制和重现 ADS-B 信号模拟过程，用于：
- 📊 **数据分析**: 回顾历史飞行轨迹和信号质量
- 🐛 **问题调试**: 重现和分析特定场景下的系统行为
- 🎓 **教学演示**: 展示 ADS-B 信号处理流程
- 🧪 **算法验证**: 使用相同数据测试不同算法版本

---

## 🎬 快速开始

### 第一步：录制数据

1. **启动应用**
   - 等待系统加载完成
   - 地图上出现模拟飞机（默认 10 架）

2. **开始录制**
   - 在左侧控制面板找到"📹 录制"区域
   - 点击 **"🔴 开始录制"** 按钮
   - 观察状态变为 **"🔴 正在录制"**

3. **停止录制**
   - 录制足够时间后（建议 30-60 秒）
   - 点击 **"💾 停止并下载"** 按钮
   - 浏览器自动下载 `adsb-recording-xxxxx.json` 文件

> 💡 **提示**: 录制文件会自动保存到浏览器 LocalStorage，即使关闭页面也不会丢失

---

### 第二步：回放数据

1. **加载录制文件**
   - 点击 **"📂 加载录制文件"** 按钮
   - 选择之前下载的 `.json` 文件
   - 等待加载完成（通常 < 1 秒）

2. **控制回放**
   - 点击 **"▶️ 播放"** 开始回放
   - 使用 **"⏸️ 暂停"** 暂停播放
   - 拖动 **进度条** 跳转到任意时间点

3. **调整播放速度**
   - 点击速度按钮切换倍速：
     - **0.5x**: 慢速播放，细节观察
     - **1x**: 原始速度
     - **2x**: 快速浏览
     - **4x**: 极速回放

4. **返回模拟**
   - 点击 **"🔄 返回模拟"** 退出回放模式
   - 系统恢复实时模拟状态

---

## 🔧 高级功能

### 录制配置

#### 自动保存策略
录制数据会在以下情况自动保存：
- ✅ 点击"停止录制"时保存到 LocalStorage
- ✅ 点击"停止并下载"时同时保存并下载文件
- ⚠️ 如果浏览器崩溃，未保存的录制会丢失

#### 存储管理
```javascript
// 在浏览器控制台查看已保存的录制
localStorage.getItem('adsb-recording-xxxxx')

// 手动删除旧录制
localStorage.removeItem('adsb-recording-xxxxx')

// 清空所有录制
localStorage.clear()
```

---

### 回放控制

#### 精确跳转
1. 暂停回放
2. 拖动进度条到目标位置
3. 查看当前时间（显示在进度条上方）
4. 继续播放或单步分析

#### 循环播放
当回放结束后：
- 状态自动切换为 **"✅ 已完成"**
- 点击 **"▶️ 播放"** 从头开始重播

#### 速度切换技巧
- **慢速（0.5x）**: 分析快速移动的飞机
- **快速（2x/4x）**: 快速浏览长时间录制
- **暂停 + 拖动**: 逐帧分析关键时刻

---

### 🗺️ 交互式轨迹回放功能（v1.1.0 新增）

#### 功能概述
在回放模式下，您可以通过**拖动时间轴**来实时查看飞机在任意时间点的飞行轨迹。该功能支持：
- 📍 **实时轨迹显示**: 拖动时间轴时，地图上实时渲染飞机从起点到当前时间的完整飞行路径
- 🎨 **颜色编码**: 轨迹颜色根据 GNSS 质量（NIC 值）动态变化
- 🔄 **状态重建**: 精确重建任意时间点的飞机位置和状态
- 👁️ **显示控制**: 可随时开启/关闭轨迹显示

#### 使用方法

1. **加载录制文件**
   - 点击 **"📂 加载录制文件"** 加载已录制的数据

2. **拖动时间轴查看轨迹**
   - 按住进度条滑块并拖动
   - 地图上会实时显示飞机从录制开始到当前时间点的轨迹线
   - 飞机图标会移动到该时间点的位置

3. **轨迹颜色含义**
   | 颜色 | NIC 值范围 | 含义 |
   |------|-----------|------|
   | 🟢 绿色 | 8-11 | GNSS 信号质量优秀 |
   | 🟡 黄色 | 4-7 | GNSS 信号质量中等 |
   | 🔴 红色 | 0-3 | GNSS 信号质量较差 |

4. **控制轨迹显示**
   - 勾选/取消勾选 **"📍 显示飞行轨迹"** 复选框
   - 也可以在地图右上角的图层控制中切换 "Trajectory" 图层

#### 使用技巧

- **分析特定时段**: 暂停播放后拖动时间轴，可以精确查看任意时刻的飞机位置和历史轨迹
- **比较信号质量**: 通过轨迹颜色变化，可以直观看出不同区域的 GNSS 信号质量
- **追踪飞行路径**: 将时间轴拖到录制结束位置，可以查看完整的飞行轨迹

---

## 📂 文件格式说明

### 录制文件结构
```json
{
  "version": "1.0.0",
  "recordedAt": "2024-01-01T12:00:00.000Z",
  "duration": 60000,
  "mapConfig": {
    "center": [39.9042, 116.4074],
    "zoom": 9
  },
  "events": [
    {
      "timestamp": 0,
      "type": "init",
      "data": {
        "truthStates": [/* 初始飞机状态 */]
      }
    },
    {
      "timestamp": 1000,
      "type": "message",
      "data": {
        "hexMessage": "8D4840D6234C..."
      }
    }
    // ... 更多事件
  ],
  "metadata": {
    "description": "ADS-B Recording - 1200 events",
    "tags": ["adsb", "simulation"]
  }
}
```

### 字段说明
- **version**: 格式版本（用于未来兼容性）
- **recordedAt**: 录制开始时间（ISO 8601 格式）
- **duration**: 总时长（毫秒）
- **mapConfig**: 地图初始配置（中心点和缩放级别）
- **events**: 事件序列（按时间戳排序）
  - `init`: 初始状态事件（仅一次）
  - `message`: ADS-B 信号事件
- **metadata**: 可选元数据

---

## 🎯 最佳实践

### 录制建议

✅ **推荐做法**:
- 录制 30-120 秒的片段（文件大小适中）
- 录制前等待飞机分布稳定
- 为录制文件添加有意义的描述（手动重命名）

❌ **避免做法**:
- 超长录制（> 30 分钟）可能导致文件过大
- 浏览器 LocalStorage 有限（约 5-10 MB）
- 录制前不要频繁刷新页面

---

### 回放建议

✅ **推荐做法**:
- 使用暂停和拖动进度条精确定位
- 使用 0.5x 速度分析关键帧
- 对比多次回放验证一致性

❌ **避免做法**:
- 加载超大文件（> 50 MB）可能导致卡顿
- 高速播放（4x）时频繁暂停/恢复

---

### 文件管理建议

✅ **推荐做法**:
- 定期导出重要录制到本地磁盘
- 为文件添加日期和场景标签
- 删除 LocalStorage 中的旧录制

❌ **避免做法**:
- 依赖浏览器 LocalStorage 长期存储
- 在不同浏览器间共享录制文件（需重新加载）

---

## ❓ 常见问题

### Q1: 录制文件存储在哪里？
**A**: 录制数据有两个存储位置：
1. **浏览器 LocalStorage**: 点击"停止录制"后自动保存
2. **本地文件**: 点击"停止并下载"后保存到下载目录

---

### Q2: 可以编辑录制文件吗？
**A**: 可以！录制文件是标准 JSON 格式，可以用文本编辑器打开并修改：
- 编辑飞机初始位置
- 删除特定事件
- 添加自定义元数据
- ⚠️ 编辑后需确保 JSON 格式正确

---

### Q3: 回放不准确怎么办？
**A**: 可能原因和解决方法：
1. **文件损坏**: 重新录制或检查 JSON 格式
2. **浏览器性能**: 降低播放速度或关闭其他标签页
3. **数据不完整**: 确保录制期间无中断

---

### Q4: 录制影响模拟性能吗？
**A**: 影响很小：
- CPU 增加 < 5%
- 内存每秒增加约 1-2 KB
- 不影响飞机模拟逻辑

---

### Q5: 可以在回放模式下录制吗？
**A**: 不可以。回放和录制是互斥模式：
- 回放时录制按钮禁用
- 录制时无法加载回放文件
- 需先退出当前模式才能切换

---

### Q6: 支持哪些浏览器？
**A**: 所有现代浏览器：
- ✅ Chrome 80+
- ✅ Firefox 75+
- ✅ Edge 80+
- ✅ Safari 13+

---

### Q7: 录制文件可以分享吗？
**A**: 可以！只需分享 `.json` 文件：
1. 发送给其他用户
2. 对方加载文件即可回放
3. 确保文件完整且未损坏

---

### Q8: LocalStorage 满了怎么办？
**A**: 解决方法：
1. 删除旧录制：
   ```javascript
   // 在浏览器控制台执行
   for (let i = 0; i < localStorage.length; i++) {
     const key = localStorage.key(i);
     if (key.startsWith('adsb-recording-')) {
       localStorage.removeItem(key);
     }
   }
   ```
2. 或使用"停止并下载"直接保存到文件

---

## 🔗 相关资源

- [测试指南](./TESTING_GUIDE.md) - 完整的功能测试用例
- [性能优化指南](./PERFORMANCE_OPTIMIZATION.md) - 高级性能优化策略
- [项目 README](./README.md) - 项目整体介绍

---

## 📞 技术支持

如遇到问题，请：
1. 查看浏览器控制台错误信息
2. 检查录制文件 JSON 格式
3. 尝试在隐私模式下重新测试
4. 提交 Issue 并附上录制文件样本

---

## 🎉 开始使用

现在您已经了解了所有功能，开始录制您的第一个 ADS-B 数据回放吧！

1. 点击 **"🔴 开始录制"**
2. 等待 60 秒
3. 点击 **"💾 停止并下载"**
4. 加载文件并 **"▶️ 播放"**

祝使用愉快！🚀
